name: Build Mouse Mover

on:
  push:
    tags: [ 'v*.*.*' ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86, x86_64, arm, arm64]
        include:
          - arch: x86
            artifact_name: mouse-linux-x86
            compiler: i686-linux-gnu-gcc
            flags: -static
          - arch: x86_64
            artifact_name: mouse-linux-x86_64
            compiler: gcc
            flags: ""
          - arch: arm
            artifact_name: mouse-linux-arm
            compiler: arm-linux-gnueabi-gcc
            flags: -static
          - arch: arm64
            artifact_name: mouse-linux-arm64
            compiler: aarch64-linux-gnu-gcc
            flags: -static

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cross-compilation tools and libraries
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-i686-linux-gnu \
          gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi \
          gcc-multilib
        sudo dpkg --add-architecture i386
        sudo dpkg --add-architecture armhf
        sudo dpkg --add-architecture arm64
        sudo apt-get update
        sudo apt-get install -y libx11-dev libxtst-dev
        sudo apt-get install -y \
          libx11-dev:i386 libxtst-dev:i386 \
          libx11-dev:armhf libxtst-dev:armhf \
          libx11-dev:arm64 libxtst-dev:arm64

    - name: Build for Linux ${{ matrix.arch }}
      run: |
        if [ "${{ matrix.arch }}" != "x86_64" ]; then
          ${{ matrix.compiler }} -o ${{ matrix.artifact_name }} mouse.c ${{ matrix.flags }} -Os -s
        else
          ${{ matrix.compiler }} -o ${{ matrix.artifact_name }} mouse.c -lX11 -lXtst -Os -s
        fi

    - name: Upload Linux ${{ matrix.arch }} artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_name }}

  build-macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, arm64]
        include:
          - arch: x86_64
            artifact_name: mouse-macos-x86_64
            flags: -arch x86_64
          - arch: arm64
            artifact_name: mouse-macos-arm64
            flags: -arch arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build for macOS ${{ matrix.arch }}
      run: |
        gcc ${{ matrix.flags }} -o ${{ matrix.artifact_name }} mouse.c -framework ApplicationServices -Os -s

    - name: Upload macOS ${{ matrix.arch }} artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_name }}

  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86
            artifact_name: mouse-windows-x86.exe
            compiler: i686-w64-mingw32-gcc
          - arch: x86_64
            artifact_name: mouse-windows-x86_64.exe
            compiler: x86_64-w64-mingw32-gcc
          - arch: arm
            artifact_name: mouse-windows-arm.exe
            compiler: armv7-w64-mingw32-gcc
          - arch: arm64
            artifact_name: mouse-windows-arm64.exe
            compiler: aarch64-w64-mingw32-gcc

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install MinGW and LLVM-Mingw
      run: |
        choco install mingw --force -y
        $url = "https://github.com/mstorsjo/llvm-mingw/releases/download/20231017/llvm-mingw-20231017-ucrt-x86_64.zip"
        Invoke-WebRequest -Uri $url -OutFile "llvm-mingw.zip"
        Expand-Archive -Path "llvm-mingw.zip" -DestinationPath "C:\llvm-mingw"
        echo "C:\llvm-mingw\bin" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

    - name: Build for Windows ${{ matrix.arch }}
      run: |
        if ("${{ matrix.arch }}" -eq "arm" -or "${{ matrix.arch }}" -eq "arm64") {
          $compiler = "C:\llvm-mingw\bin\aarch64-w64-mingw32-gcc.exe"
          if ("${{ matrix.arch }}" -eq "arm") {
            $compiler = "C:\llvm-mingw\bin\armv7-w64-mingw32-gcc.exe"
          }
          & $compiler mouse.c -luser32 -O2 -o ${{ matrix.artifact_name }}
        } else {
          $compiler = "${{ matrix.compiler }}"
          & $compiler mouse.c -luser32 -O2 -o ${{ matrix.artifact_name }}
        }

    - name: Upload Windows ${{ matrix.arch }} artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_name }}

  build-android:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86, x86_64, arm, arm64]
        include:
          - arch: x86
            artifact_name: mouse-android-x86
            compiler: i686-linux-android30-clang
          - arch: x86_64
            artifact_name: mouse-android-x86_64
            compiler: x86_64-linux-android30-clang
          - arch: arm
            artifact_name: mouse-android-arm
            compiler: armv7a-linux-androideabi30-clang
          - arch: arm64
            artifact_name: mouse-android-arm64
            compiler: aarch64-linux-android30-clang

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Android NDK
      uses: android-actions/setup-android@v2

    - name: Set up Android build environment
      run: |
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/tools/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

    - name: Build for Android ${{ matrix.arch }}
      run: |
        $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.compiler }} \
          -o ${{ matrix.artifact_name }} mouse.c -Os -static

    - name: Upload Android ${{ matrix.arch }} artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_name }}
